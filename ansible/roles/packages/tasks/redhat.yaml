---
- name: "redhat fips:ensure fips_enabled is 1"
  lineinfile:
    name: /proc/sys/crypto/fips_enabled
    line: "1"
    state: present
  check_mode: yes
  register: sysfips

- name: install dracut fips
  yum:
    name:
      - dracut-fips
    state: present
    enablerepo: "{{ 'offline' if offline_mode_enabled else '' }}"
    disablerepo: "{{ '*' if offline_mode_enabled else '' }}"
  when:
    - fips.enabled
    - not sysfips.found

- name: redhat fips: regenerate the kernel initramfs
  command: dracut --force
  become: yes
  when:
    - ansible_os_family == "RedHat"
    - fips.enabled
    - not sysfips.found

- name: redhat fips: enable fips mode for kernel
  lineinfile:
    state: present
    dest: /etc/default/grub
    backrefs: yes
    regexp: '^(GRUB_CMDLINE_LINUX=(?!.* fips)\"[^\"]+)(\".*)'
    line: '\1 fips=1\2'
  when:
    - ansible_distribution == 'Red Hat Enterprise Linux'
    - fips.enabled
    - not sysfips.found

- name: redhat fips:rebuild the grub config
  command: grub2-mkconfig -o /boot/grub2/grub.cfg
  when:
    - ansible_os_family == "RedHat"
    - fips.enabled
    - not sysfips.found

- name: redhat fips:reboot to pick up fips changes
  ansible.builtin.reboot:
  when:
    - sysprep
    - ansible_os_family == "RedHat"
    - fips.enabled
    - not sysfips.found
    - fips_reboot

- name: install common RPMS
  yum:
    name:
      - audit
      - ca-certificates
      - conntrack-tools
      - chrony
      - curl
      - ebtables
      - open-vm-tools
      - python3-pip
      - "python{{ '3' if ansible_distribution_major_version == '8' }}-netifaces"
      - "python{{ '3' if ansible_distribution_major_version == '8' }}-requests"
      - socat
      - sysstat
      - nfs-utils
      - NetworkManager
    state: present
    enablerepo: "{{ 'offline' if offline_mode_enabled else '' }}"
    disablerepo: "{{ '*' if offline_mode_enabled else '' }}"
    update_cache: true
  register: result
  until: result is success
  retries: 5
  delay: 3

- name: enable auditd
  systemd:
    name: auditd
    enabled: true

- name: install el8 requirements
  yum:
    name:
      - iproute-tc
    state: present
    enablerepo: "{{ 'offline' if offline_mode_enabled else '' }}"
    disablerepo: "{{ '*' if offline_mode_enabled else '' }}"
  when:
    - ansible_distribution_major_version == '8'

- name: remove versionlock for kubelet and kubectl packages
  command: yum versionlock delete {{ item }}
  with_items:
    - kubelet
    - kubectl
  args:
    warn: false
  ignore_errors: true
  register: command_result
  changed_when: >
    'command_result.stdout is regex(".*versionlock deleted: [1-9]+.*")'
  when:
    - versionlock_plugin_enabled
    - item in exportedversionlocklist.stdout

- name: install kubectl rpm package
  yum:
    name: "{{ 'kubectl-' + package_versions.kubernetes_rpm }}"
    state: present
    update_cache: true
    enablerepo: "{{ 'offline' if offline_mode_enabled else '' }}"
    disablerepo: "{{ '*' if offline_mode_enabled else '' }}"
  register: result
  until: result is success
  retries: 3
  delay: 3

- name: install kubelet rpm package
  yum:
    name: "{{ 'kubelet-' + package_versions.kubernetes_rpm }}"
    state: present
    update_cache: true
    enablerepo: "{{ 'offline' if offline_mode_enabled else '' }}"
    disablerepo: "{{ '*' if offline_mode_enabled else '' }}"
  register: kubelet_installation_rpm
  until: kubelet_installation_rpm is success
  retries: 3
  delay: 3

- name: add versionlock for kubelet and kubectl packages
  command: yum versionlock add {{ item }}
  with_items:
    - kubelet
    - kubectl
  args:
    warn: false
  register: command_result
  changed_when: >
    'command_result.stdout is regex(".*versionlock added: [1-9]+.*")'
  when:
    - versionlock_plugin_enabled

- include: oracle.yaml
  when: ansible_distribution == "OracleLinux"
