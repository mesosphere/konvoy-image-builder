---
- name: install apt-transport-https deb package
  apt:
    name: apt-transport-https
    state: latest
    update_cache: true
  register: result
  until: result is success
  retries: 3
  delay: 3


- name: apt update package management cache
  apt:
    update_cache: true
  register: result
  until: result is success
  retries: 3
  delay: 3

- name: install common debs
  apt:
    name:
      - chrony
      - nfs-common
      - python3-cryptography
      - python3-pip
    state: present
  register: result
  until: result is success
  retries: 3
  delay: 3

# The latest cloud-init version '23.3.1-0ubuntu1~20.04.1 is unable to run #boothook created by CAPA
# https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/0bf78b04b305a77aec37a68c107102231faa7a16/pkg/cloud/services/secretsmanager/secret_fetch_script.go#L20
# This is a workaround to downgrade to older cloud-init version. 
# Once the fix is available in cloud-init and base ubuntu AMI are built with the fixed cloud-init,
# we can revert to using cloud-init version provided by the base AMI. 
- name: Install cloud-init version 23.1.2-0ubuntu0~20.04.2
  apt:
    name: cloud-init=23.1.2-0ubuntu0~20.04.2
    state: present
    force_apt_get: true
    allow_downgrade: true
  when: ansible_os_family == "Debian"

- name: Install cloud-init packages
  apt:
    name: "{{ packages }}"
    state: present
    force_apt_get: true
  vars:
    packages:
      - cloud-guest-utils
      - cloud-initramfs-copymods
      - cloud-initramfs-dyn-netconf
      - cloud-initramfs-growroot
  when: ansible_os_family == "Debian"

- name: remove version hold for kubelet and kubectl packages
  command: apt-mark unhold {{ item }}
  with_items:
    - kubelet
    - kubectl


- name: install kubelet deb package
  apt:
    name: kubelet={{ package_versions.kubernetes_deb }}
    state: present
    force: true
  register: kubelet_installation_deb
  until: kubelet_installation_deb is success
  retries: 3
  delay: 3

- name: install kubectl deb package
  apt:
    name: kubectl={{ package_versions.kubernetes_deb }}
    state: present
    force: true
  register: result
  until: result is success
  retries: 3
  delay: 3

- name: add version hold for kubelet and kubectl packages
  command: apt-mark hold {{ item }}
  with_items:
    - kubelet
    - kubectl
