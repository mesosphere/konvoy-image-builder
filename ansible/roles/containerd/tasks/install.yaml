---
- name: Gather os-release facts
  ansible.utils.cli_parse:
    command: cat /etc/os-release
    parser:
      name: ansible.netcommon.native
      command: cat os-release
      os: linux
    set_fact: os_release

- name: Set containerd_tar_file
  set_fact:
    containerd_tar_file: "containerd-{{ containerd_version }}-{{ os_release.ID }}-{{ ansible_distribution_version }}-d2iq{{ build_name_extra }}.1.tar.gz"


# Check if containerd file already exists
# used to skip the download when offline
- name: check if the containerd tar exists
  changed_when: false
  stat:
    path: "{{ containerd_remote_bundle_path }}/{{ containerd_tar_file }}"
  register: containerd_tar_file_exists

- name: create containerd bundle directory
  file:
    path: "{{ containerd_remote_bundle_path }}"
    state: directory
  when:
    - not containerd_tar_file_exists.stat.exists

- name: download containerd
  get_url:
    url: "{{ containerd_base_url }}/{{ containerd_tar_file }}"
    dest: "{{ containerd_remote_bundle_path }}/{{ containerd_tar_file }}"
    mode: 0600
  when:
    - not containerd_tar_file_exists.stat.exists

- name: unpack containerd
  unarchive:
    remote_src: True
    src: "{{ containerd_remote_bundle_path }}/{{ containerd_tar_file }}"
    dest: /
    extra_opts:
      - --no-overwrite-dir

# Remove /opt/cni directory, as we will install cni later
- name: delete /opt/cni directory
  file:
    path: /opt/cni
    state: absent

# Remove /etc/cni directory, as we will configure cni later
- name: delete /etc/cni directory
  file:
    path: /etc/cni
    state: absent

# We run ctr. When we do, it must be in the PATH of the ansible process. On some distributions, /usr/local/bin is not in
# the PATH. The symlink makes ctr available in /usr/bin, which is in the PATH across all distributions where we install
# ctr. We do not install ctr on flatcar, but there it is already in the PATH.
- name: symlink ctr to /usr/local/bin
  file:
    src: "/usr/local/bin/{{ item }}"
    dest: "/usr/bin/{{ item }}"
    mode: 0777
    state: link
    force: yes
  loop:
    - ctr
