# Copyright 2019 The Kubernetes Authors.

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

# http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Get cloud-init version when in path
  shell: command -v cloud-init 2>&1 >/dev/null && cloud-init --version 2>&1 | cut -d' ' -f2
  register: cloud_init_version_cmd
  changed_when: false

- name: Set cloud-init version fact
  set_fact:
    cloud_init_version: cloud_init_version_cmd.stdout

# when cloud-init 21.3 or higher is installed to not touch it
- name: Cloud-init patches for cloud-init versions <21.3
  include_tasks: vmware-cloudinit.yml
  when: ( cloud_init_version == "" ) or (cloud_init_version is version('21.3', '<'))

- name: Get a list of services
  service_facts:

- name: Disable Hyper-V KVP protocol daemon on Ubuntu
  systemd:
    name: hv-kvp-daemon
    state: stopped
    enabled: false
  when: ('hv-kvp-daemon.service' in ansible_facts.services) and (ansible_os_family == "Debian")

- name: Create provider vmtools config drop-in file
  copy:
    src: files/etc/vmware-tools/tools.conf
    dest: /etc/vmware-tools/tools.conf
    owner: root
    group: root
    mode: 0644

- name: Get a list of services
  service_facts:

- name: Disable UFW firewall on Ubuntu/Debian
  systemd:
    name: ufw
    state: stopped
    enabled: false
  when: ('ufw.service' in ansible_facts.services) and (ansible_os_family == "Debian")

# See https://kb.vmware.com/s/article/82229
# From systemd docs: 
# "If a valid D-Bus machine ID is already configured for the system, 
# the D-Bus machine ID is copied and used to initialize the machine ID in /etc/machine-id"
# This needs to be reset/truncated as well on Ubuntu.
- name: Truncate D-Bus machine-id
  file:
    path: /var/lib/dbus/machine-id
    state: absent
  when: ansible_os_family == "Debian" 

- name: Link D-Bus machine-id to /etc/machine-id
  file:
    path: /var/lib/dbus/machine-id
    state: link
    src: /etc/machine-id
  when: ansible_os_family == "Debian"
