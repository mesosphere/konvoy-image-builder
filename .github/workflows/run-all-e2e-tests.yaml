# Runs Azure tests when pull request opened, repopened or synchronized
name: E2E Tests - Run all tests on PR
on:
  workflow_dispatch:
  pull_request:
    types: [labeled, synchronize]

permissions:
  contents: read
  id-token: write

jobs:
  set-global-conditions:
    runs-on: ubuntu-latest
    outputs:
      runs_e2e_tests: ${{ steps.set_runs_e2e_tests.outputs.RUNS_E2E_TESTS }}
    if: |
      github.event_name == 'pull_request' &&
      (
        (github.event.action == 'labeled' &&  github.event.label.name == 'runs-e2e-tests-temp') ||
        (github.event.action == 'synchronize' && contains(github.event.pull_request.labels.*.name, 'runs-e2e-tests-temp'))
      ) ||
      contains(fromJson('["workflow_dispatch"]'), github.event_name)
    steps:
      - id: set_runs_e2e_tests
        name: Set RUNS_E2E_TESTS env
        run: echo "RUNS_E2E_TESTS=true" >> "$GITHUB_OUTPUT"

  build-devkit-image:
    needs: set-global-conditions
    if: ${{ needs.set-global-conditions.outputs.runs_e2e_tests == 'true' }}
    uses: ./.github/workflows/build-devkit-image.yaml
    secrets: inherit
    with:
      run-tests: true

  gcp-e2e-tests:
    needs: [set-global-conditions, build-devkit-image]
    if: ${{ needs.set-global-conditions.outputs.runs_e2e_tests == 'true' }}
    uses: ./.github/workflows/gcp-e2e.yaml
    secrets: inherit
    with:
      run-tests: true
  
  aws-e2e-tests:
    needs: [set-global-conditions, build-devkit-image]
    if: ${{ needs.set-global-conditions.outputs.runs_e2e_tests == 'true' }}
    uses: ./.github/workflows/aws-e2e.yaml
    secrets: inherit
    with:
      run-tests: true

  vsphere-e2e-tests:
    needs: [set-global-conditions, build-devkit-image]
    if: ${{ needs.set-global-conditions.outputs.runs_e2e_tests == 'true' }}
    uses: ./.github/workflows/vsphere-e2e.yaml
    secrets: inherit
    with:
      run-tests: true

  azure-e2e-tests:
    needs: [set-global-conditions, build-devkit-image]
    if: ${{ needs.set-global-conditions.outputs.runs_e2e_tests == 'true' }}
    uses: ./.github/workflows/azure-e2e.yaml
    secrets: inherit
    with:
      run-tests: true
